{% extends "layout.html" %}
{% block footer_scripts %}
<script type="text/javascript">
    $(document).ready(function() {
        var jobsTable = $('#frames').dataTable({
            "bProcessing": true,
            "iDisplayLength": 25,
            "aaData": {{ entries | safe }},
            "aoColumns": [
                {'iDataSort': 2},
                null,
                null,
                null,
                null,
                null,
                null
            ],

            "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
                var btn_status = "";
                $('td:eq(1)', nRow).hide();
                $('td:eq(6)', nRow).html(filelink(aData));
            }
        });

        function filelink(aData) {
          var data = aData[6];
          //var pathlist = data.split(',');
          var container = $('<div></div>');
          for (i in data) {
            var filename = data[i].split('/');
            filename = filename[filename.length-1];
            var link = $('<a href="/frames/download/{{show_id}}/'+ filename +'?path='+ data[i] +'" class="download_frame" id="' + data[i] + '"> ' + filename + '</a>');
            link.appendTo(container);
            $('<br>').appendTo(container);
          }
          return container.html()
        }

        // $(document).on("click", ".download_frame", function() {
        //   window.location = $(this).attr('id');
        // });

        $(document).on("click", ".status-toggle", function() {
            // var status = $(this).html();
            // var tableRow = $(this).parents("tr");
            // var rowPosition = jobsTable.fnGetPosition(tableRow[0]);
            // var clientId = tableRow.attr("id").split("_")[1];

            // if (status == 'enabled') {
            //     data = {id : clientId, status: 'disabled'};
            //     $.post('/workers/edit', data, function() {
            //         console.log('Worker is now disabled');
            //         jobsTable.fnUpdate('disabled', rowPosition ,4);
            //     });
            // } else if (status == 'disabled') {
            //     data = {id : clientId, status: 'enabled'};
            //     $.post('/workers/edit', data, function() {
            //         console.log('Worker is now enabled');
            //         jobsTable.fnUpdate('enabled', rowPosition ,4);
            //     });
            // }
        });

        $(document).on("click", "#reset-failed-frames",

          function() {
            params = {
              'id': '',
              'command': 'reset_failed'
            };
            $.post("/frames/reset/{{shot_id}}", params)
              .done(function(data) {
                console.log('Reseted failed frames');
              });
          });

        $(document).on("click", "#reset-frames",

          function() {

            var frames = new Array();

            var checkbox_list = $("tbody input:checked");
            for (var i = checkbox_list.length - 1; i >= 0; i--) {
              var checkbox = checkbox_list[i];
              frames.push($(checkbox).val());
            };

            if (frames.length == 0) {
              alert("Please select one or more frames");
              return false;
            };

            //console.log(frames);
            frame_ids = frames.join();

            command = $(this).attr('command');
            params = {
              'id': frame_ids,
              'command': command
            }

            $.post("/frames/reset/{{shot_id}}", params)
              .done(function(data) {
                console.log('Frame ' + frame_ids + ' reset: ' + command);
              });

          });

        $(document).on("click", ".check-all", function(){
            $("table input[type=checkbox]").attr('checked', $(this).is(':checked'));
        });
    });
</script>
{% endblock %}
{% block body %}
    <h1 class="page-title">{{title}}</h1>
    <h3>{{project_name}} / {{shot_name}}</h3>
    <hr>
    <div class="row">
        <div class="col-md-12">
            <div id="reset-frames" class="btn btn-info" command="reset">Reset</div>
            <div id="reset-failed-frames" class="btn btn-warning" command="reset_failed">Retry Failed</div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-md-12">
            <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-condensed" id="frames">
                <thead>
                    <tr>
                        <th width="10%"><input class="check-all" type="checkbox"></th>
                        <th width="10%">Frame</th>
                        <th width="10%">Status</th>
                        <th width="20%">Duration</th>
                        <th width="">Worker</th>
                        <th width="">Files Path</th>
                        <th width="0%"></th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
                <tfoot>
                    <tr>
                        <th></th>
                        <th>Frame</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Worker</th>
                        <th>Files Path</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

{% endblock %}
